# Развертывание

## Требования

Для запуска API Gateway Service необходимы:

- Go 1.19 или выше
- Доступ к внутренним микросервисам
- Доступ к сервису аутентификации
- Конфигурационные файлы

## Локальный запуск

### Сборка проекта

```bash
cd services/api-gw
go build -o api-gw cmd/main.go
```

### Запуск сервиса

```bash
./api-gw
```

По умолчанию сервис будет использовать следующие параметры:
- HTTP сервер: порт 8080
- gRPC сервер: адрес из переменной окружения GRPC_ADDRESS или :50051
- Конфигурационные файлы: .env и config/services.json

### Параметры запуска

```bash
./api-gw -config-path=/path/to/.env -services-config=/path/to/services.json
```

## Docker

### Сборка образа

```bash
docker build -t api-gw -f Dockerfile .
```

### Запуск контейнера

```bash
docker run -p 8080:8080 -p 50051:50051 api-gw
```

## Docker Compose

В корневой директории проекта находится файл `docker-compose.yaml`, который позволяет запустить всю систему целиком:

```bash
docker-compose up
```

Это запустит API Gateway вместе со всеми зависимыми сервисами.

## Переменные окружения

| Переменная | Назначение | Значение по умолчанию |
|------------|------------|-----------------------|
| GRPC_ADDRESS | Адрес gRPC сервера | :50051 |
| AUTH_SERVICE_URL | URL сервиса аутентификации | http://auth-service:8080 |

## Конфигурация сервисов

Файл `config/services.json` должен содержать корректные URL всех внутренних сервисов. При использовании Docker Compose имена сервисов должны соответствовать именам сервисов в docker-compose.yaml.

Пример конфигурации:

```json
{
  "services": [
    {
      "name": "employee",
      "url": "http://employee-service:8080"
    },
    {
      "name": "client",
      "url": "http://client-service:8080"
    }
  ]
}
```

## Мониторинг

### Health Check

Для проверки состояния сервиса можно использовать endpoint `/health`:

```bash
curl http://localhost:8080/health
```

### Логи

Все запросы и ошибки логгируются в стандартный вывод. При запуске в Docker логи можно посмотреть командой:

```bash
docker logs <container_id>
```

## Масштабирование

API Gateway может быть масштабирован горизонтально. Несколько экземпляров могут работать за балансировщиком нагрузки.

### Ограничения

При горизонтальном масштабировании необходимо учитывать:
- Rate limiting осуществляется на уровне отдельного экземпляра
- Нет распределенного хранения состояния между экземплярами
- Для полноценного масштабирования требуется внешнее хранилище для rate limiting

## Безопасность

### Аутентификация

Все endpoints (кроме `/health`) требуют аутентификации. Токен должен передаваться в заголовке `Authorization`.

### Rate Limiting

Каждый клиент ограничен 100 запросами в минуту. При превышении лимита возвращается ошибка 429 Too Many Requests.

### CORS

API Gateway поддерживает CORS, разрешая запросы с любых доменов. В продакшен среде рекомендуется ограничить разрешенные источники.
# Middleware

API Gateway Service использует несколько middleware компонентов для обработки запросов. Middleware - это функции, которые выполняются последовательно и могут модифицировать запросы и ответы, а также выполнять различные проверки.

## Auth Middleware

Auth Middleware отвечает за аутентификацию пользователей. Он проверяет наличие заголовка `Authorization` в запросе и вызывает сервис аутентификации для проверки токена.

### Принцип работы

1. Извлекает токен из заголовка `Authorization`
2. Вызывает сервис аутентификации для проверки токена
3. Если токен действителен, добавляет информацию о пользователе в контекст запроса
4. Если токен недействителен или отсутствует, возвращает ошибку 401 Unauthorized

### Использование

Auth Middleware применяется ко всем маршрутам, которые требуют аутентификации.

## Rate Limit Middleware

Rate Limit Middleware ограничивает количество запросов от одного клиента в заданный промежуток времени.

### Принцип работы

1. Определяет клиента по IP-адресу
2. Проверяет количество запросов от клиента за последний интервал времени
3. Если лимит не превышен, разрешает выполнение запроса
4. Если лимит превышен, возвращает ошибку 429 Too Many Requests

### Конфигурация

По умолчанию установлен лимит 100 запросов в минуту на одного клиента.

## Logging Middleware

Logging Middleware записывает информацию о всех входящих запросах и исходящих ответах.

### Принцип работы

1. Записывает время начала обработки запроса
2. Логгирует метод, путь и IP-адрес клиента
3. Обрабатывает запрос
4. Записывает статус ответа и время обработки

### Формат логов

```
Started {method} {path} from {ip}
Completed {method} {path} with {status} in {duration}
```

## CORS Middleware

CORS Middleware добавляет необходимые заголовки для поддержки Cross-Origin Resource Sharing.

### Принцип работы

1. Добавляет заголовки `Access-Control-Allow-Origin`, `Access-Control-Allow-Methods`, `Access-Control-Allow-Headers`
2. Обрабатывает preflight OPTIONS запросы
3. Передает управление следующему обработчику

## Recovery Middleware

Recovery Middleware перехватывает паники в приложении и возвращает клиенту корректную ошибку.

### Принцип работы

1. Восстанавливается после паники с помощью `recover()`
2. Логгирует информацию о панике и стек вызовов
3. Возвращает клиенту ошибку 500 Internal Server Error